name: Python CI

# Prevent accidental cancellation of other runs; customize the group if needed.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Use specific, supported minor versions. Avoid typos like '3.1' (which is NOT '3.11').
        python-version: [3.12, 3.11]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Check Python version (debug)
        shell: bash
        run: |
          echo "Python setup:"
          python --version || true
          which python || true

      - name: Install dependencies (if any)
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found -- skipping dependency installation"
          fi

      - name: "Debug: show installed packages and environment"
        shell: bash
        run: |
          echo "-- python --version --"
          python --version || true
          echo "-- which python --"
          which python || true
          echo "-- pip --version --"
          pip --version || true
          echo "-- pip freeze (top 50 lines) --"
          pip freeze | sed -n '1,50p' || true
          echo "-- disk usage --"
          df -h || true
          echo "-- environment vars (selected) --"
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
          echo "RUNNER_OS=$RUNNER_OS"

      - name: Run tests (pytest)
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH=.
          if ls tests/*.py >/dev/null 2>&1; then
            pytest -q
          else
            echo "No tests found; skipping pytest"
          fi

      - name: Run session scripts (with timeout to avoid hangs)
        shell: bash
        run: |
          set -euo pipefail
          echo "Running session1.py (timeout 30s)"
          timeout 30s python session1.py || {
            rc=$?; echo "session1.py exited with code $rc"; exit $rc
          }
          echo "Running session2.py (timeout 30s)"
          timeout 30s python session2.py || {
            rc=$?; echo "session2.py exited with code $rc"; exit $rc
          }
